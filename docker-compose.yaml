x-common: &common
  restart: always
  env_file: .env
  tty: true
  stdin_open: true
  stop_grace_period: 1s

x-backend-common: &backend-common
  <<: *common
  image: polimane-backend
  build:
    context: .
    dockerfile: ./ci/dev/backend/Dockerfile
  volumes:
  - ./backend:/app
  - gomod_cache:/go/pkg/mod
  depends_on:
  - db
  - sqs

services:
  nginx:
    <<: *common
    image: nginx:1.29-alpine
    volumes:
    - ./ci/dev/nginx/nginx.conf:/etc/nginx/nginx.conf
    - ./ci/dev/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf
    - ./ci/dev/nginx/partials:/etc/nginx/partials
    ports:
    - "80:80"
    depends_on:
    - frontend
    - backend

  frontend:
    <<: *common
    build:
      context: .
      dockerfile: ./ci/dev/frontend/Dockerfile
    command: bun --bun dev
    volumes:
    - ./frontend:/app
    - ./frontend/node_modules:/app/node_modules
    - bun_cache:/root/.bun/install/cache

  backend:
    <<: *backend-common
    command: make dev_api

  worker:
    <<: *backend-common
    command: make dev_worker

  db:
    <<: *common
    build: ./ci/dev/database
    environment:
      COCKROACH_ARGS: start-single-node --insecure
    ports:
    - "26257:26257"
    volumes:
    - cockroach_data:/cockroach/cockroach-data

  sqs:
    <<: *common
    image: softwaremill/elasticmq-native
    volumes:
    - ./ci/dev/sqs/elasticmq.conf:/opt/elasticmq.conf
    ports:
    - "9324:9324"
    - "9325:9325"

volumes:
  bun_cache:
    driver: local
  gomod_cache:
    driver: local
  cockroach_data:
    driver: local
